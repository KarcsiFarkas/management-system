{% extends "layout.html" %}
{% block content %}
<form action="{{ url_for('generate') }}" method="post" id="profile-form">
    <div class="form-header">
        <div class="card">
            <h2>User and Deployment Type</h2>
            <div class="form-row">
                <div>
                    <label for="username">Username</label>
                    {% if profile_data %}
                    <input type="text" id="username" name="username" value="{{ profile_data.username }}" required readonly>
                    {% else %}
                    <input type="text" id="username" name="username" value="" required>
                    {% endif %}
                    <p class="help-text">This will be the name of the git branch. Cannot be changed after creation.</p>
                </div>
                <div>
                    <label>Deployment Type</label>
                    <div class="radio-group">
                        <input type="radio" id="type_docker" name="deployment_type" value="docker" {% if not profile_data or profile_data.deployment_type == 'docker' %}checked{% endif %}>
                        <label for="type_docker">Docker Compose</label>

                        <input type="radio" id="type_nix" name="deployment_type" value="nix" {% if profile_data and profile_data.deployment_type == 'nix' %}checked{% endif %}>
                        <label for="type_nix">NixOS</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-columns">
        <div class="available-services-column card">
            <h2>Available Services</h2>
            <input type="text" id="service-search" placeholder="Search services...">

            <div class="service-actions">
                <button type="button" id="add-all-services" class="button">Add All</button>
                <button type="button" id="remove-all-services" class="button">Remove All</button>
            </div>

            <ul id="service-list">
                {% for service in config.services %}
                <li data-service-id="{{ service.id }}">
                    <input type="checkbox" id="select_{{ service.id }}"
                           name="service_{{ service.id }}"
                           class="service-select-checkbox"
                           data-controls-card="card-{{ service.id }}"
                           {% if profile_data and service.id in profile_data.services %}checked{% endif %}>
                    <label for="select_{{ service.id }}"><strong>{{ service.name }}</strong></label>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="selected-services-column">
            <div id="global-settings">
                 <div id="docker-fields" class="deployment-fields card">
                    <h3>Global Docker Settings</h3>
                    {% for field in config.global_fields.docker %}
                        <label for="global_docker_{{ field.name }}">{{ field.label }}</label>
                        {% set field_value = profile_data[field.name] if profile_data and field.name in profile_data else field.default|default('') %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="global_docker_{{ field.name }}" value="{{ field_value }}" placeholder="{{ field.placeholder|default('') }}" {% if field.required %}required{% endif %}>
                    {% endfor %}
                </div>
                <div id="nix-fields" class="deployment-fields card">
                    <h3>Global NixOS Settings</h3>
                    {% for field in config.global_fields.nix %}
                        <label for="global_nix_{{ field.name }}">{{ field.label }}</label>
                        {% set field_value = profile_data[field.name] if profile_data and field.name in profile_data else field.default|default('') %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="global_nix_{{ field.name }}" value="{{ field_value }}" placeholder="{{ field.placeholder|default('') }}" {% if field.required %}required{% endif %}>
                    {% endfor %}
                </div>
            </div>

            <h2>Selected Services</h2>
            <div id="selected-services-container">
                <p id="no-services-message">Select services from the left to configure them here.</p>

                {% for service in config.services %}
                <div id="card-{{ service.id }}" class="service-options-card card" style="display: none;">
                    <div class="service-card-header">
                        <div class="service-card-title">
                            <h4>{{ service.name }}</h4>
                            <p class="help-text">{{ service.description }}</p>
                        </div>
                        <button type="button" class="toggle-button">
                            <span class="toggle-text">Collapse</span>
                            <span class="toggle-arrow">â–¼</span>
                        </button>
                    </div>

                    <div class="service-card-body">
                        <div class="docker-fields deployment-fields">
                            {% for field in service.docker_fields %}
                                <label for="{{ service.id }}_{{ field.name }}">{{ field.label }}</label>
                                {% set field_value = profile_data[field.name] if profile_data and field.name in profile_data else field.default|default('') %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" value="{{ field_value }}" {% if field.required %}required{% endif %}>
                            {% endfor %}
                        </div>
                        <div class="nix-fields deployment-fields">
                            {% for field in service.nix_fields %}
                                <label for="{{ service.id }}_{{ field.name }}">{{ field.label }}</label>
                                {% if field.type == 'checkbox' %}
                                    {% set is_checked = (profile_data and profile_data[field.name] == 'true') or (not profile_data and field.default) %}
                                    <input type="checkbox" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" {% if is_checked %}checked{% endif %}>
                                {% else %}
                                    {% set field_value = profile_data[field.name] if profile_data and field.name in profile_data else field.default|default('') %}
                                    <input type="{{ field.type }}" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" value="{{ field_value }}" {% if field.required %}required{% endif %}>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if service.notes %}
                            <p class="help-text"><em>Note: {{ service.notes }}</em></p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="form-footer">
        {% if profile_data %}
        <button type="submit" class="button primary">Update Profile</button>
        {% else %}
        <button type="submit" class="button primary">Generate Profile</button>
        {% endif %}
    </div>
</form>
{% endblock %}