{% extends "layout.html" %}
{% block content %}
<form action="{{ url_for('views.save_profile' if not tenant_name_override else 'admin.save_tenant_profile') }}" method="POST" id="profile-form">

    {% if tenant_name_override %}
        <input type="hidden" name="tenant_name_override" value="{{ tenant_name_override }}">
    {% endif %}

    <div class="card summary-card">
        <div class="service-card-header">
            <div class="service-card-title">
                <h4>General Settings</h4>
                <p class="help-text">Core settings for your deployment profile.</p>
            </div>
            <div class="service-card-controls">
                <button type="button" class="toggle-button">
                    <span class="toggle-text">Collapse</span>
                    <span class="toggle-arrow">‚ñº</span>
                </button>
            </div>
        </div>
        <div class="service-card-body">
            <div class="form-row">
                <div>
                    <label for="tenant_domain">Tenant Domain</label>
                    <input type="text" id="tenant_domain" name="tenant_domain" value="{{ profile_data.general.tenant_domain if profile_data and profile_data.general else current_user.global_domain }}">
                </div>
                <div>
                    <label>Deployment Type</label>
                    <ul class="selectable-list deployment-type-list">
                        <li>
                            <input type="radio" id="type_docker" name="deployment_runtime" value="docker" {% if not profile_data or (profile_data.general and profile_data.general.deployment_runtime == 'docker') %}checked{% endif %}>
                            <label for="type_docker">Docker Compose</label>
                        </li>
                        <li>
                            <input type="radio" id="type_nix" name="deployment_runtime" value="nix" {% if profile_data and profile_data.general and profile_data.general.deployment_runtime == 'nix' %}checked{% endif %}>
                            <label for="type_nix">NixOS</label>
                        </li>
                    </ul>
                </div>
            </div>
             <div class="form-row">
                <div>
                    <label for="timezone">Timezone</label>
                    <input type="text" id="timezone" name="timezone" value="{{ profile_data.general.timezone if profile_data and profile_data.general else current_user.global_timezone }}">
                </div>
                <div>
                    <label for="universal_username">Universal Service Username</label>
                    <input type="text" id="universal_username" name="universal_username" value="{{ profile_data.general.universal_username if profile_data and profile_data.general else current_user.username }}">
                </div>
            </div>
             <div class="form-row">
                 <div>
                    <label for="password_mode_select">Password Mode</label>
                    <select name="password_mode" id="password_mode_select">
                        <option value="generate" {% if not profile_data or (profile_data.general and profile_data.general.password_mode != 'custom') %}selected{% endif %}>Generate unique passwords (Recommended)</option>
                        <option value="custom" {% if profile_data and profile_data.general and profile_data.general.password_mode == 'custom' %}selected{% endif %}>Use a custom universal password</option>
                    </select>
                </div>
                <div id="custom_password_field" style="display: {% if profile_data and profile_data.general and profile_data.general.password_mode == 'custom' %}block{% else %}none{% endif %};">
                    <label for="universal_password_custom">Custom Universal Password</label>
                    <input type="password" id="universal_password_custom" name="universal_password_custom" value="{{ profile_data.general.universal_password_custom if profile_data and profile_data.general else '' }}">
                    <p class="help-text">Warning: Using the same password for multiple services is a security risk.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tailscale VPN Configuration -->
    <div class="card summary-card">
        <div class="service-card-header">
            <div class="service-card-title">
                <h4>üîí Tailscale VPN (Optional Remote Access)</h4>
                <p class="help-text">Enable secure remote access to your server via Tailscale VPN. Access your services from anywhere without exposing ports.</p>
            </div>
            <div class="service-card-controls">
                <button type="button" class="toggle-button">
                    <span class="toggle-text">Collapse</span>
                    <span class="toggle-arrow">‚ñº</span>
                </button>
            </div>
        </div>
        <div class="service-card-body">
            <div class="form-row">
                <div>
                    <label for="tailscale_enabled">
                        <input type="checkbox" id="tailscale_enabled" name="tailscale_enabled"
                               {% if (profile_data and profile_data.tailscale and profile_data.tailscale.enabled) or (not profile_data) %}checked{% endif %}>
                        Enable Tailscale VPN
                    </label>
                    <p class="help-text">
                        Tailscale creates a secure mesh VPN network. Install by default for remote access.
                        <a href="https://tailscale.com/" target="_blank" rel="noopener">Learn more ‚Üí</a>
                    </p>
                </div>
            </div>

            <div id="tailscale_config" style="display: {% if (profile_data and profile_data.tailscale and profile_data.tailscale.enabled) or (not profile_data) %}block{% else %}none{% endif %};">
                <div class="form-row">
                    <div>
                        <label for="tailscale_auth_key">Tailscale Auth Key <span class="required">*</span></label>
                        <input type="password" id="tailscale_auth_key" name="tailscale_auth_key"
                               value="{{ profile_data.tailscale.auth_key if profile_data and profile_data.tailscale else '' }}"
                               placeholder="tskey-auth-xxxxx-yyyyy">
                        <p class="help-text">
                            Get your auth key from <a href="https://login.tailscale.com/admin/settings/keys" target="_blank" rel="noopener">Tailscale Admin Console</a>.
                            Recommended: Use one-time keys for production. This key will be stored securely as an environment variable.
                        </p>
                    </div>
                    <div>
                        <label for="tailscale_hostname">Hostname (Optional)</label>
                        <input type="text" id="tailscale_hostname" name="tailscale_hostname"
                               value="{{ profile_data.tailscale.hostname if profile_data and profile_data.tailscale else '' }}"
                               placeholder="my-paas-server">
                        <p class="help-text">Name for this device in your Tailscale network. Defaults to server hostname if not specified.</p>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label for="tailscale_tags">Tags (comma-separated)</label>
                        <input type="text" id="tailscale_tags" name="tailscale_tags"
                               value="{{ profile_data.tailscale.tags|join(',') if profile_data and profile_data.tailscale and profile_data.tailscale.tags else 'tag:paas-server' }}"
                               placeholder="tag:server,tag:production">
                        <p class="help-text">Tailscale ACL tags for access control. Example: tag:production,tag:web-server</p>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>
                            <input type="checkbox" id="tailscale_ssh" name="tailscale_ssh"
                                   {% if profile_data and profile_data.tailscale and profile_data.tailscale.ssh %}checked{% endif %}>
                            Enable Tailscale SSH
                        </label>
                        <p class="help-text">Access server via SSH through Tailscale without exposing port 22 publicly.</p>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="tailscale_accept_dns" name="tailscale_accept_dns"
                                   {% if (profile_data and profile_data.tailscale and profile_data.tailscale.accept_dns) or (not profile_data) %}checked{% endif %}>
                            Accept Tailscale DNS
                        </label>
                        <p class="help-text">Use Tailscale's DNS for seamless name resolution (recommended).</p>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>
                            <input type="checkbox" id="tailscale_accept_routes" name="tailscale_accept_routes"
                                   {% if profile_data and profile_data.tailscale and profile_data.tailscale.accept_routes %}checked{% endif %}>
                            Accept Advertised Routes
                        </label>
                        <p class="help-text">Accept subnet routes from other devices in your Tailscale network.</p>
                    </div>
                    <div>
                        <label>
                            <input type="checkbox" id="tailscale_advertise_exit_node" name="tailscale_advertise_exit_node"
                                   {% if profile_data and profile_data.tailscale and profile_data.tailscale.advertise_exit_node %}checked{% endif %}>
                            Advertise as Exit Node
                        </label>
                        <p class="help-text">Allow other devices to route all internet traffic through this server.</p>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label for="tailscale_advertise_routes">Advertise Routes (comma-separated CIDR)</label>
                        <input type="text" id="tailscale_advertise_routes" name="tailscale_advertise_routes"
                               value="{{ profile_data.tailscale.advertise_routes|join(',') if profile_data and profile_data.tailscale and profile_data.tailscale.advertise_routes else '' }}"
                               placeholder="192.168.1.0/24,10.0.0.0/8">
                        <p class="help-text">Make this server a subnet router. Other Tailscale devices can access these networks.</p>
                    </div>
                    <div>
                        <label for="tailscale_exit_node">Use Exit Node</label>
                        <input type="text" id="tailscale_exit_node" name="tailscale_exit_node"
                               value="{{ profile_data.tailscale.exit_node if profile_data and profile_data.tailscale and profile_data.tailscale.exit_node != 'none' else '' }}"
                               placeholder="exit-node-hostname">
                        <p class="help-text">Route all traffic through a specific exit node (hostname or IP). Leave empty to disable.</p>
                    </div>
                </div>

                <div class="alert-info" style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong>üí° Quick Setup:</strong> For basic remote access, just enable Tailscale and provide an auth key. The defaults work for most users!
                    <br><br>
                    <strong>üîê Security Note:</strong> Your Tailscale auth key is stored as an environment variable and never committed to Git.
                    It's used once during deployment to connect your server to your Tailscale network.
                </div>
            </div>
        </div>
    </div>

    <div class="form-columns">
        <div class="available-services-column card">
            <h2>Available Services</h2>
            <input type="text" id="service-search" placeholder="Search services...">
            <div class="service-actions">
                <button type="button" id="add-all-services" class="button">Add All</button>
                <button type="button" id="remove-all-services" class="button">Remove All</button>
            </div>
            <ul id="service-list" class="selectable-list">
                {% for service in config.services %}
                <li data-service-id="{{ service.id }}">
                    <label for="select_{{ service.id }}">
                        <input type="checkbox" id="select_{{ service.id }}"
                               name="service_{{ service.id }}"
                               class="service-select-checkbox"
                               data-controls-card="card-{{ service.id }}"
                               {% if profile_data and profile_data.services and service.id in profile_data.services %}checked{% endif %}>
                        <strong>{{ service.name }}</strong>
                        <a href="{{ service.url }}" class="external-link-icon" target="_blank" rel="noopener noreferrer" title="Visit official site">üîó</a>
                    </label>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="selected-services-column">
            <h2>Selected Services</h2>
            <div id="selected-services-container">
                <p id="no-services-message">Select services from the left to configure them here.</p>
                {% for service in config.services %}
                <div id="card-{{ service.id }}" class="service-options-card card" style="display: none;">
                    <div class="service-card-header">
                        <div class="service-card-title">
                            <h4>
                                {{ service.name }}
                                <a href="{{ service.url }}" class="external-link-icon" target="_blank" rel="noopener noreferrer" title="Visit official site">üîó</a>
                            </h4>
                            <p class="help-text">{{ service.description }}</p>
                        </div>
                        <div class="service-card-controls">
                            <button type="button" class="toggle-button">
                                <span class="toggle-text">Collapse</span>
                                <span class="toggle-arrow">‚ñº</span>
                            </button>
                            <button type="button" class="remove-service-btn" data-service-id="{{ service.id }}" title="Remove this service">√ó</button>
                        </div>
                    </div>
                    <div class="service-card-body">
                        <div class="docker-fields deployment-fields">
                            {% for field in service.docker_fields %}
                                <label for="{{ service.id }}_{{ field.name }}">{{ field.label }}</label>
                                {% set field_value = profile_data.services[service.id].options[field.name] if profile_data and profile_data.services and service.id in profile_data.services and field.name in profile_data.services[service.id].options else field.default %}
                                <input type="{{ field.type }}" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" value="{{ field_value | default('', true) }}" {% if field.required %}required{% endif %}>
                            {% endfor %}
                        </div>
                        <div class="nix-fields deployment-fields">
                            {% for field in service.nix_fields %}
                                <label for="{{ service.id }}_{{ field.name }}">{{ field.label }}</label>
                                {% set is_checked = profile_data.services[service.id].options[field.name] if profile_data and profile_data.services and service.id in profile_data.services and field.name in profile_data.services[service.id].options else field.default %}
                                {% if field.type == 'checkbox' %}
                                    <input type="checkbox" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" {% if is_checked %}checked{% endif %}>
                                {% else %}
                                    <input type="{{ field.type }}" name="{{ field.name }}" id="{{ service.id }}_{{ field.name }}" value="{{ is_checked | default('', true) }}" {% if field.required %}required{% endif %}>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if service.notes %}
                            <p class="help-text"><em>Note: {{ service.notes }}</em></p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="form-footer">
        <button type="submit" class="button primary">
            {% if profile_data %}Update Profile{% else %}Generate Profile{% endif %}
        </button>
    </div>
</form>
{% endblock %}