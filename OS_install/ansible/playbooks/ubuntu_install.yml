---
- name: Ubuntu minimal install (autoinstall or cloud-init image) + Docker optional
  hosts: ubuntu
  become: true
  vars:
    minimal_pkgs: [vim, curl, ca-certificates, net-tools, git, unzip, rsync, mosh]
  tasks:
    - name: Wait for SSH (host up)
      wait_for:
        port: 22
        delay: 5
        timeout: 900

    - name: Ensure minimal packages
      apt:
        name: "{{ minimal_pkgs }}"
        state: present
        update_cache: true

    - name: Ensure users and SSH keys
      loop: "{{ users }}"
      loop_control: { loop_var: u }
      user:
        name: "{{ u.username }}"
        shell: "{{ u.shell | default('/bin/bash') }}"
        groups: "{{ 'sudo' if u.sudo else omit }}"
        state: present
      register: created_users

    - name: Authorized keys
      authorized_key:
        user: "{{ item.0.username }}"
        key: "{{ item.1 }}"
      with_subelements:
        - "{{ users }}"
        - ssh_authorized_keys

    - name: Configure netplan (static if requested)
      when: not network.dhcp
      template:
        src: ../templates/netplan-static.yaml.j2
        dest: /etc/netplan/01-installer-config.yaml
        mode: "0600"

    - name: Apply netplan (if changed)
      command: netplan apply
      when: not network.dhcp

    - name: Ensure Chezmoi binary is installed
      block:
        - name: Check if Chezmoi is already present
          stat:
            path: /usr/local/bin/chezmoi
          register: chezmoi_stat

        - name: Install Chezmoi from official release
          when: not chezmoi_stat.stat.exists
          shell: |
            set -euo pipefail
            tmp="$(mktemp -d)"
            trap 'rm -rf "$tmp"' EXIT
            cd "$tmp"
            curl -fsSL https://github.com/twpayne/chezmoi/releases/latest/download/chezmoi-linux-amd64 -o chezmoi
            install -m 0755 chezmoi /usr/local/bin/chezmoi
          args:
            creates: /usr/local/bin/chezmoi
            executable: /bin/bash

    - name: Install Docker (optional)
      when: docker_enabled | bool
      block:
        - name: Setup apt keyrings + repo
          shell: |
            set -e
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
            . /etc/os-release
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            ${VERSION_CODENAME} stable" > /etc/apt/sources.list.d/docker.list
        - apt:
            update_cache: true
        - apt:
            name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
            state: present
