---
- name: Ubuntu minimal install (autoinstall or cloud-init image) + Docker optional
  hosts: ubuntu
  become: true
  vars:
    minimal_pkgs: [vim, curl, ca-certificates, net-tools, git, unzip, rsync, mosh]
    chezmoi_required_packages: [python3, python3-yaml, jq, yq, tar]
    chrony_packages: [chrony, tzdata-legacy]
    docker_networks:
      - name: traefik_net
        driver: bridge
        attachable: true
    primary_user: >-
      {{
        (
          users | default([])
          | selectattr('username', 'defined')
          | map(attribute='username')
          | list
          | first
        ) | default('root')
      }}
    docker_runtime_root: "/srv/paas"
    docker_media_root: "{{ docker_runtime_root }}/data"
    docker_downloads_root: "{{ docker_runtime_root }}/downloads"
    docker_media_subdirs_primary:
      - syncthing
      - seafile
      - immich
      - movies
      - tv
      - music
      - navidrome
      - plex
      - jellyfin
      - shared
    docker_download_subdirs:
      - qbittorrent
      - incoming
  tasks:
    - name: Wait for SSH (host up)
      wait_for:
        port: 22
        delay: 5
        timeout: 900

    - name: Ensure minimal packages
      apt:
        name: "{{ minimal_pkgs }}"
        state: present
        update_cache: true

    - name: Install Bacula console client
      apt:
        name: bacula-console-qt
        state: present

    - name: Add Helix editor PPA
      apt_repository:
        repo: ppa:maveonair/helix-editor
        state: present

    - name: Install Helix editor
      apt:
        name: helix
        state: present
        update_cache: true

    - name: Ensure Chezmoi helper packages are installed
      apt:
        name: "{{ chezmoi_required_packages }}"
        state: present

    - name: Ensure Chrony log directory exists
      file:
        path: /var/log/chrony
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install Chrony time synchronization stack
      apt:
        name: "{{ chrony_packages }}"
        state: present

    - name: Ensure Docker group exists when Docker support is enabled
      when: docker_enabled | bool
      group:
        name: docker
        state: present

    - name: Ensure users and SSH keys
      loop: "{{ users }}"
      loop_control: { loop_var: u }
      vars:
        requested_groups: >-
          {{
            (
              (u.groups | default([])) +
              (['sudo'] if u.sudo else []) +
              (['docker'] if docker_enabled | bool else [])
            ) | unique
          }}
      user:
        name: "{{ u.username }}"
        shell: "{{ u.shell | default('/bin/bash') }}"
        groups: "{{ requested_groups | join(',') if requested_groups | length > 0 else omit }}"
        append: true
        state: present
      register: created_users

    - name: Authorized keys
      authorized_key:
        user: "{{ item.0.username }}"
        key: "{{ item.1 }}"
      with_subelements:
        - "{{ users }}"
        - ssh_authorized_keys

    - name: Configure netplan (static if requested)
      when: not network.dhcp
      template:
        src: ../templates/netplan-static.yaml.j2
        dest: /etc/netplan/01-installer-config.yaml
        mode: "0600"

    - name: Apply netplan (if changed)
      command: netplan apply
      when: not network.dhcp

    - name: Ensure Chezmoi binary is installed
      block:
        - name: Check if Chezmoi is already present
          stat:
            path: /usr/local/bin/chezmoi
          register: chezmoi_stat

        - name: Install Chezmoi from official release
          when: not chezmoi_stat.stat.exists
          shell: |
            set -euo pipefail
            tmp="$(mktemp -d)"
            trap 'rm -rf "$tmp"' EXIT
            cd "$tmp"
            curl -fsSL https://github.com/twpayne/chezmoi/releases/latest/download/chezmoi-linux-amd64 -o chezmoi
            install -m 0755 chezmoi /usr/local/bin/chezmoi
          args:
            creates: /usr/local/bin/chezmoi
            executable: /bin/bash

    - name: Install Docker (optional)
      when: docker_enabled | bool
      block:
        - name: Ensure Docker apt prerequisites are installed
          apt:
            name:
              - ca-certificates
              - curl
            state: present
        - name: Create Docker apt keyring directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"
        - name: Detect dpkg architecture for Docker repo
          command: dpkg --print-architecture
          register: docker_dpkg_arch
          changed_when: false
        - name: Download Dockerâ€™s official GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: "0644"
        - name: Configure Docker apt repository
          copy:
            dest: /etc/apt/sources.list.d/docker.list
            content: |
              deb [arch={{ docker_dpkg_arch.stdout | default('amd64') }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release | default('noble') }} stable
            owner: root
            group: root
            mode: "0644"
        - apt:
            update_cache: true
        - apt:
            name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
            state: present
        - name: Ensure Docker runtime config directory exists
          file:
            path: /etc/paas
            state: directory
            owner: root
            group: root
            mode: "0755"
        - name: Render Docker runtime configuration
          template:
            src: ../templates/docker-runtime-config.yaml.j2
            dest: /etc/paas/docker-runtime.yaml
            owner: root
            group: root
            mode: "0644"
        - name: Ensure Docker networks exist
          shell: |
            set -euo pipefail
            if docker network inspect {{ item.name }} >/dev/null 2>&1; then
              exit 0
            fi
            docker network create \
              --driver {{ item.driver | default('bridge') }} \
              {% if item.attachable | default(false) %}--attachable {% endif %}{{ item.name }}
          args:
            executable: /bin/bash
          loop: "{{ docker_networks }}"
          loop_control:
            label: "{{ item.name }}"
          register: docker_network_result
          changed_when: docker_network_result.stdout != ""
          failed_when: docker_network_result.rc not in [0]
        - name: Ensure Docker runtime base directories exist
          file:
            path: "{{ item }}"
            state: directory
            owner: "{{ primary_user }}"
            group: "{{ primary_user }}"
            mode: "0755"
          loop:
            - "{{ docker_runtime_root }}"
            - "{{ docker_media_root }}"
            - "{{ docker_downloads_root }}"
        - name: Ensure media directories exist for user-managed services
          file:
            path: "{{ docker_media_root }}/{{ item }}"
            state: directory
            owner: "{{ primary_user }}"
            group: "{{ primary_user }}"
            mode: "0775"
          loop: "{{ docker_media_subdirs_primary }}"
        - name: Ensure Nextcloud shared storage directory is writable
          file:
            path: "{{ docker_media_root }}/nextcloud"
            state: directory
            owner: "www-data"
            group: "www-data"
            mode: "0770"
        - name: Ensure Gitea data directory exists
          file:
            path: "{{ docker_media_root }}/gitea"
            state: directory
            owner: "{{ primary_user }}"
            group: "{{ primary_user }}"
            mode: "0775"
        - name: Ensure downloads directories exist
          file:
            path: "{{ docker_downloads_root }}/{{ item }}"
            state: directory
            owner: "{{ primary_user }}"
            group: "{{ primary_user }}"
            mode: "0775"
          loop: "{{ docker_download_subdirs }}"
